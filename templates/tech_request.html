{% extends 'techhomeheader.html' %}
{% block content %}
<div class="container py-5">
  <h2 class="text-center mb-4">Technician User Request View</h2>

  <div class="accordion" id="techRequestAccordion">
    {% for tech in forms3 %}
    <div class="accordion-item mb-3">
      <h2 class="accordion-header" id="heading{{ tech.id }}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#collapse{{ tech.id }}" aria-expanded="false" aria-controls="collapse{{ tech.id }}">
          {{ tech.user.Name }} - {{ tech.Date }} @ {{ tech.Time }}
        </button>
      </h2>
      <div id="collapse{{ tech.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ tech.id }}"
        data-bs-parent="#techRequestAccordion">
        <div class="accordion-body">
          <ul class="list-group mb-3">
            <li class="list-group-item"><strong>Contact:</strong> {{ tech.user.Contact_no }}</li>
            <li class="list-group-item"><strong>Date:</strong> {{ tech.Date }}</li>
            <li class="list-group-item"><strong>Time:</strong> {{ tech.Time }}</li>
            <li class="list-group-item"><strong>Error Code:</strong> {{ tech.Error_code }}</li>
            <li class="list-group-item">
              <strong>Error Image:</strong><br>
              {% if tech.Error_img %}
              <img src="{{ tech.Error_img.url }}" alt="Error Image" class="img-fluid rounded border"
                style="max-height: 200px;">
              {% else %}
              <span class="text-muted">No image uploaded.</span>
              {% endif %}
            </li>

            <li class="list-group-item">
              <strong>Request Status:</strong>
              {% if tech.status == 1 %}
              <span class="badge bg-danger">Cancelled</span>
              {% else %}
              <span class="badge bg-success">Active</span>
              {% endif %}
            </li>

            <li class="list-group-item">
              <strong>Approval Status:</strong>
              {% if tech.tech_status == 1 %}
              <span class="badge bg-success">Approved</span>
              {% elif tech.tech_status == 2 %}
              <span class="badge bg-danger">Rejected</span>
              {% elif tech.status == 1 %}
              <span class="badge bg-secondary">Cancelled</span>
              {% else %}
              <a href="{% url 'techapprove' tech.id %}" class="btn btn-sm btn-success">Approve</a>
              <a href="{% url 'techreject' tech.id %}" class="btn btn-sm btn-danger">Reject</a>
              {% endif %}
            </li>

            <li class="list-group-item">
              <strong>Payment Status:</strong>
              {% if tech.tech_status == 0 or tech.tech_status == 2 %}
              <span class="text-muted">Not yet Approved</span>
              {% elif tech.tech_status == 1 and tech.pa_status == 0 %}
              <span class="text-warning">Not Paid</span>
              {% else %}
              <span class="text-success">Paid</span>
              {% endif %}
            </li>

            <li class="list-group-item">
              <strong>Status Tracking:</strong>
              {% if tech.status == 1 or tech.tech_status == 2 %}
              <span class="text-muted">N/A</span>
              {% else %}
              <a href="{% url 'tech_status' tech.id %}" class="btn btn-sm btn-info">Update Status</a>
              {% endif %}
            </li>

            <!-- Delivery Status Section -->
            <li class="list-group-item">
              <strong>Delivery Status:</strong><br>
              {% with orders=tech.order_set.all %}
                {% if orders %}
                  {% for order in orders %}
                    <div class="mb-1">
                      <span class="me-2">Order #{{ order.id }}:</span>
                      {% if order.del_status == 2 %}
                        <span class="badge bg-success">Delivered</span>
                      {% elif order.del_status == 1 %}
                        <span class="badge bg-warning text-dark">Out for Delivery</span>
                      {% else %}
                        <span class="badge bg-secondary">Not Delivered</span>
                      {% endif %}
                    </div>
                  {% endfor %}
                {% else %}
                  <span class="text-muted">No orders placed</span>
                {% endif %}
              {% endwith %}
            </li>
          </ul>

          <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'tech_chat' tech.user.loginid.id %}" class="btn btn-outline-primary btn-sm">Chat</a>
            <a href="{% url 'tech_order' tech.id %}" class="btn btn-outline-secondary btn-sm">View Parts</a>
            <a href="{% url 'techpartsview' tech.id %}" class="btn btn-outline-dark btn-sm">Parts Purchase</a>
          </div>

        </div>
      </div>
    </div>
    {% empty %}
    <p class="text-center text-muted">No requests available at the moment.</p>
    {% endfor %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
