{% extends 'userhomeheader.html' %}
{% load static %}

{% block content %}
<style>
    body {
        background: linear-gradient(135deg, #f2f6fa, #e0eafc);
    }

    .booking-card {
        background-color: white;
        border-radius: 15px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        padding: 30px;
        transition: all 0.3s ease-in-out;
    }

    .booking-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
    }

    .form-label {
        font-weight: 600;
        color: #333;
    }

    .btn-primary {
        background: linear-gradient(135deg, #0066ff, #3399ff);
        border: none;
        padding: 10px 30px;
        font-size: 16px;
        border-radius: 30px;
        transition: 0.3s ease;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #005ce6, #2d88ff);
        box-shadow: 0 4px 12px rgba(0, 102, 255, 0.4);
    }

    .preview {
        border-radius: 10px;
        border: 2px solid #ccc;
        padding: 5px;
        background: #fafafa;
    }

    h2.title-glam {
        background: linear-gradient(90deg, #003366, #0059b3);
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    select:disabled {
        background-color: #f8f8f8;
    }
</style>

<div class="container mt-5" style="max-width: 700px;">
    <div class="booking-card">
        <h2 class="title-glam">Book a Technician</h2>

        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <div class="mb-4">
            <h5 class="text-primary">Technician: {{ t_data.Name }}</h5>
        </div>

        <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}

            <div class="mb-3">
                <label for="id_Error_code" class="form-label">Error Code</label>
                {{ forms3.Error_code }}
            </div>

            <div class="mb-3">
                <label for="id_Date" class="form-label">Date</label>
                {{ forms3.Date }}
            </div>

            <div class="mb-3">
                <label for="id_Time" class="form-label">Available Time Slots</label>
                {{ forms3.Time }}
            </div>

            <div class="mb-3">
                <label for="id_Error_img" class="form-label">Upload Error Image (optional)</label>
                {{ forms3.Error_img }}
            </div>

            {% if image_url %}
                <div class="mb-3">
                    <label class="form-label">Uploaded Image:</label><br>
                    <img src="{{ image_url }}" alt="Uploaded Error Image" class="preview" style="max-width:100%; max-height:300px;">
                </div>
            {% endif %}

            <div class="text-center">
                <button type="submit" class="btn btn-primary">Book Technician</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const dateInput = document.getElementById("id_Date");
        const timeSelect = document.getElementById("id_Time");
        const technicianId = "{{ t_data.id }}";

        const today = new Date().toISOString().split('T')[0];
        dateInput.setAttribute("min", today);

        dateInput.addEventListener("change", function () {
            const selectedDate = this.value;
            if (!selectedDate) return;

            timeSelect.disabled = true;
            timeSelect.innerHTML = "<option>Loading...</option>";

            fetch(`/get-slots/${technicianId}/?date=${selectedDate}`)
                .then(response => response.json())
                .then(data => {
                    timeSelect.innerHTML = "";

                    if (data.slots && data.slots.length > 0) {
                        data.slots.forEach(slot => {
                            const option = document.createElement("option");
                            option.value = slot[0];
                            option.textContent = slot[1];
                            timeSelect.appendChild(option);
                        });
                    } else {
                        const option = document.createElement("option");
                        option.value = "";
                        option.textContent = "No slots available";
                        timeSelect.appendChild(option);
                    }

                    timeSelect.disabled = false;
                })
                .catch(error => {
                    console.error("Error fetching slots:", error);
                    timeSelect.innerHTML = "<option>Error loading slots</option>";
                    timeSelect.disabled = false;
                });
        });
    });
</script>
{% endblock %}
