<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AC Chatbot</title>
  <style>
  :root {
    --cool-blue: #d9f2ff;
    --ice-white: #f5faff;
    --sky-blue: #a0d8ef;
    --frost-blue: #e0f7ff;
    --chill-gray: #c2d6e0;
    --deep-blue: #2a5d8f;
    --text-dark: #233b4d;
    --text-light: #ffffff;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    scroll-behavior: smooth;
  }

  body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--ice-white);
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #chatContainer {
    width: 95%;
    max-width: 450px;
    height: 90vh;
    background: var(--frost-blue);
    border-radius: 20px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  #chatOutput {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
    background: var(--ice-white);
  }

  #chatOutput p {
    margin: 0;
    padding: 12px 16px;
    border-radius: 18px;
    max-width: 75%;
    word-wrap: break-word;
    font-size: 14px;
    line-height: 1.5;
    opacity: 0;
    transform: translateY(20px);
    animation: slideIn 0.4s forwards;
  }

  .user-message {
    align-self: flex-end;
    background-color: var(--sky-blue);
    color: var(--text-light);
    text-align: right;
  }

  .bot-message {
    align-self: flex-start;
    background-color: var(--chill-gray);
    color: var(--text-dark);
    text-align: left;
  }

  .typing-indicator {
    font-style: italic;
    color: #555;
    align-self: flex-start;
  }

  #inputContainer {
    display: flex;
    padding: 10px;
    background: var(--frost-blue);
    border-top: 1px solid var(--chill-gray);
    gap: 10px;
  }

  #fileInput {
    flex: 1;
    padding: 10px;
    border: 1px solid var(--chill-gray);
    border-radius: 8px;
    background: white;
    font-size: 14px;
  }

  #sendButton {
    background: var(--deep-blue);
    color: var(--text-light);
    border: none;
    border-radius: 8px;
    padding: 0 20px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
  }

  #sendButton:hover {
    background: #1b4c75;
  }

  @keyframes slideIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .typing-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background-color: var(--frost-blue); /* matches AC theme */
  border-radius: 18px;
  max-width: fit-content;
  font-size: 22px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  animation: fadeIn 0.4s ease-in-out;
}

.typing-indicator .flake,
.typing-indicator .air {
  display: inline-block;
  animation: coolPulse 1.6s infinite ease-in-out both;
  transform-origin: center;
}

.typing-indicator .flake:nth-child(1) {
  animation-delay: 0s;
}
.typing-indicator .air {
  animation-delay: 0.2s;
}
.typing-indicator .flake:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes coolPulse {
  0%, 100% {
    transform: translateY(0) scale(1);
    opacity: 0.5;
  }
  50% {
    transform: translateY(-6px) scale(1.2);
    opacity: 1;
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

</style>
</head>
<body>

<div id="chatContainer">
  <div id="chatOutput"></div>
  <div id="inputContainer">
    <input type="text" id="textInput" placeholder="Ask AC Related question..." />
    <button id="sendButton">Send</button>
  </div>
</div>

<script>
const chatOutput = document.getElementById('chatOutput');
const textInput  = document.getElementById('textInput');
const sendButton = document.getElementById('sendButton');

let inactivityTimer = null;  // Inactivity tracker

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    document.cookie.split(';').forEach(cookie => {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
      }
    });
  }
  return cookieValue;
}

sendButton.addEventListener('click', () => {
  const userMessage = textInput.value.trim();
  if (!userMessage) return;

  appendMessage(userMessage, 'user-message');
  scrollBottom();
  resetInactivityTimer();  // Reset timer when user sends message

  const typing = appendTyping();
  scrollBottom();

  const formData = new FormData();
  formData.append('question', userMessage);
  formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

  fetch('/acqn/', {
    method: 'POST',
    body: formData
  })
  .then(r => r.json())
  .then(data => {
    typing.remove();

    if (data.error) {
      appendMessage(`<span style="color:red;">${data.error}</span>`, 'bot-message');
    } else {
      showLineByLineStreaming(data.answer);
    }

    textInput.value = '';
  })
  .catch(err => {
    typing.textContent = 'Sorry, something went wrong.';
    console.error(err);
  });
});

function appendMessage(message, className) {
  const p = document.createElement('p');
  p.className = className;
  p.innerHTML = message;
  chatOutput.appendChild(p);
}

function appendTyping() {
  const typing = document.createElement('div');
  typing.className = 'typing-indicator';
  typing.innerHTML = `
    <span class="flake">❄️</span>
    <span class="air">❄️</span>
    <span class="flake">❄️</span>
  `;
  chatOutput.appendChild(typing);
  return typing;
}



// ✅ Line-by-line streaming display function
function showLineByLineStreaming(message) {
  const p = document.createElement('p');
  p.className = 'bot-message';
  chatOutput.appendChild(p);

  const lines = message.split('\n').filter(line => line.trim() !== '');
  let currentLine = 0;

  function showNextLine() {
    if (currentLine < lines.length) {
      p.innerHTML += lines[currentLine] + "<br>";
      scrollBottom();
      currentLine++;
      setTimeout(showNextLine, 400);  // You can adjust typing speed here
    }
  }

  showNextLine();
}

function scrollBottom() {
  chatOutput.scrollTop = chatOutput.scrollHeight;
}

// Inactivity timer functions
function resetInactivityTimer() {
  if (inactivityTimer) clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    appendMessage("Do you need any other details or assistance?", 'bot-message');
    scrollBottom();
  }, 60000);  // 1 minute = 60000ms
}

// Start inactivity timer on page load
window.onload = () => {
  appendMessage("Welcome! Ask me any AC-related question.", 'bot-message');
  scrollBottom();
  resetInactivityTimer();
};
</script>

</body>

</html>
